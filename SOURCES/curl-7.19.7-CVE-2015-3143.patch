From 81400478dfcb15c56af3dc8242975daf42c05f88 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Thu, 16 Apr 2015 13:26:46 +0200
Subject: [PATCH] ConnectionExists: for NTLM re-use, require credentials to
 match

CVE-2015-3143

Bug: http://curl.haxx.se/docs/adv_20150422A.html
Reported-by: Paras Sethia

Upstream-commit: 31be461c6b659312100c47be6ddd5f0f569290f6
Signed-off-by: Kamil Dudka <kdudka@redhat.com>
---
 lib/url.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lib/url.c b/lib/url.c
index f318931..37ebb96 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -2750,7 +2750,8 @@ ConnectionExists(struct SessionHandle *data,
           }
         }
         if(!(needle->protocol & (PROT_HTTP | PROT_HTTPS))
-                || (data->state.authhost.want & CURLAUTH_NTLM)) {
+                || (data->state.authhost.want & CURLAUTH_NTLM)
+                || (check->ntlm.state != NTLMSTATE_NONE)) {
           /* This protocol requires credentials per connection or is HTTP+NTLM,
              so verify that we're using the same name and password as well */
           if(!strequal(needle->user, check->user) ||
-- 
2.3.6

