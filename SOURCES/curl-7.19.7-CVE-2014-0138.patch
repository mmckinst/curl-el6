From 417ea50515971a7fd5ac5fc715e5fb5863e869a2 Mon Sep 17 00:00:00 2001
From: Steve Holme <steve_holme@hotmail.com>
Date: Thu, 20 Feb 2014 23:51:36 +0000
Subject: [PATCH 2/2] url: Fixed connection re-use when using different log-in
 credentials

In addition to FTP, other connection based protocols such as IMAP, POP3,
SMTP, SCP, SFTP and LDAP require a new connection when different log-in
credentials are specified. Fixed the detection logic to include these
other protocols.

Bug: http://curl.haxx.se/docs/adv_20140326A.html

[upstream commit 517b06d657aceb11a234b05cc891170c367ab80d]

Signed-off-by: Kamil Dudka <kdudka@redhat.com>
---
 lib/url.c | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/lib/url.c b/lib/url.c
index f54251e..e33b5fa 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -2738,11 +2738,10 @@ ConnectionExists(struct SessionHandle *data,
             continue;
           }
         }
-        if((needle->protocol & PROT_FTP) ||
-           ((needle->protocol & PROT_HTTP) &&
-            (data->state.authhost.want & CURLAUTH_NTLM))) {
-          /* This is FTP or HTTP+NTLM, verify that we're using the same name
-             and password as well */
+        if(!(needle->protocol & (PROT_HTTP | PROT_HTTPS))
+                || (data->state.authhost.want & CURLAUTH_NTLM)) {
+          /* This protocol requires credentials per connection or is HTTP+NTLM,
+             so verify that we're using the same name and password as well */
           if(!strequal(needle->user, check->user) ||
              !strequal(needle->passwd, check->passwd)) {
             /* one of them was different */
-- 
1.8.3.1

